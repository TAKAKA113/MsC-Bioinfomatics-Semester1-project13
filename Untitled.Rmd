---
title: "LLM.tutorial"
output: html_document
date: "2025-12-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.




1.  **実行可能なダミーデータの追加**: コードをただ読むだけでなく、実際に動かして数値を確認できるようにしました。
2.  **図解（プロット）の追加**: 固定効果とランダム効果の違い、BLUE（予測値）の意味を視覚的に理解するためのグラフ描画コードを追加しました。
3.  **理論的補足**: 統計用語（BLUE vs BLUP）の正確な区別や、数式的な背景を少し補足して理解を深めるようにしました。

-----
````markdown
---
title: "Linear Mixed Models (LMM) 実践ガイド"
author: "Generated by Gemini"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# 必要なライブラリのインストールと読み込み
if (!require("lme4")) install.packages("lme4")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("lmerTest")) install.packages("lmerTest") # p値などの表示用

library(lme4)
library(tidyverse)
library(lmerTest)
````

# はじめに：このノートブックの目的

このドキュメントは、**Linear Mixed Model (LMM)** の構造、固定効果・ランダム効果の意味、そして育種価（BLUE/BLUP）の計算過程を、Rのコードを動かしながら理解するためのものです。

# 0\. データの準備（シミュレーション）

解説を動かすために、仮想的な実験データを作成します。
**シナリオ**:

  * **Genotype (品種)**: 10品種 (ランダム効果)
  * **Location (場所)**: 3箇所 A, B, C (固定効果)
  * **SPno**: 収量や特性などの応答変数

<!-- end list -->

```{r create_data}
set.seed(123) # 再現性のため乱数を固定

# パラメータ設定
n_genotypes <- 10
n_locations <- 3
reps <- 3 # 各場所での繰り返し数

# データフレーム作成
genotypes <- paste0("Geno_", 1:n_genotypes)
locations <- c("Loc_A", "Loc_B", "Loc_C")

df <- expand.grid(Genotype = genotypes, Location = locations, Rep = 1:reps)

# 真の効果（シミュレーション用）
true_intercept <- 15.8
loc_effects <- c(0, 2.1, -1.5) # A=0(基準), B=+2.1, C=-1.5
names(loc_effects) <- locations

# ランダム効果（品種ごとの真の能力）を正規分布から生成
geno_effects <- rnorm(n_genotypes, mean = 0, sd = 2)
names(geno_effects) <- genotypes

# データの生成: y = Intercept + Loc + Geno + Error
df$SPno <- true_intercept + 
           loc_effects[df$Location] + 
           geno_effects[df$Genotype] + 
           rnorm(nrow(df), mean = 0, sd = 1) # 残差

# データの確認
head(df)
```

# 1\. LMM の基本構造

線形混合モデルの基本式は以下の通りです。

$$
y_{ij} = \underbrace{\mu + \beta_i}_{\text{固定効果}} + \underbrace{u_j}_{\text{ランダム効果}} + \underbrace{\epsilon_{ij}}_{\text{残差}}
$$

  * **応答値 ($y_{ij}$)**: 観測されたデータ (SPno)
  * **Intercept ($\mu$)**: 基準レベルの平均
  * **固定効果 ($\beta_i$)**: 環境・処理による差 (Location)
  * **ランダム効果 ($u_j$)**: 個体・品種による平均からのズレ (Genotype)
  * **残差 ($\epsilon_{ij}$)**: モデルで説明できないノイズ

## モデルの実行

Rの `lmer` 関数を使って解析します。

```{r run_model}
# モデル式: SPno ~ Location + (1 | Genotype)
# (1 | Genotype) は「Genotypeごとに切片（平均）がランダムに変動する」という意味
model_tkw <- lmer(SPno ~ Location + (1 | Genotype), data = df)

# 結果の要約
summary(model_tkw)
```

# 2\. Intercept（切片）とは何か？

Rのデフォルトでは、アルファベット順で最初の水準が「基準 (Reference Level)」になります。

  * ここでは **Loc\_A** が基準です。
  * **Intercept** = 固定効果の基準レベル (Loc\_A) における平均値の推定値。

<!-- end list -->

```{r check_intercept}
# 固定効果の表示
fixef(model_tkw)
```

# 3\. 固定効果（Fixed Effects）

場所 (Location) による平均的なズレを表します。

  * `(Intercept)`: Loc\_A の平均
  * `LocationLoc_B`: Loc\_A に対する Loc\_B の差
  * `LocationLoc_C`: Loc\_A に対する Loc\_C の差

**重要なポイント**:
固定効果は「環境の差」であり、品種の能力ではありません。品種選抜のための能力値計算（BLUE計算）においては、これらは\*\*補正（除外）\*\*されるべき要素です。

# 4\. ランダム効果（Random Effects）

各品種 (Genotype) が、全体の平均から「どれくらい優れているか/劣っているか」を表す偏差です。これを統計学的には **BLUP (Best Linear Unbiased Prediction)** と呼びます。

```{r extract_ranef}
# ランダム効果の抽出
ranef(model_tkw)$Genotype %>% head()
```

  * 正の値：平均より高い能力を持つ
  * 負の値：平均より低い能力を持つ

# 5\. BLUE (Best Linear Unbiased Estimate) の計算

ここでは、環境差を補正した「純粋な品種の能力値（推定値）」を計算します。
一般的に育種の文脈では以下のように計算します。

$$
\text{Predicted Value} = \text{Intercept (基準)} + \text{Random Effect (品種のズレ)}
$$

> **補足（用語の精査）**:
> 統計学的に厳密に言うと、「BLUE」は固定効果の推定値を指し、ランダム効果は「BLUP」と呼びます。
> ここで求めようとしている「Intercept + Random Effect」は、**「条件付き平均 (Conditional Mean)」** や **「遺伝子型値 (Genotypic Value)」** と呼ばれることが多いですが、実務上これをBLUEと呼ぶ慣習もあるため、ここではコードの意図に合わせて計算を進めます。

# 6\. 実際の計算ステップ

実際にデータフレーム操作を行って、品種ごとの値を算出します。

### ① 固定効果の基準（Intercept）の抽出

```{r step1_intercept}
# 固定効果のテーブル化
fixed_tkw <- fixef(model_tkw) %>%
  as.data.frame() %>%
  rownames_to_column("Term") %>%
  rename(Fixed_Estimate = ".")

# Interceptの値だけを取り出す
intercept_value <- fixed_tkw %>% 
  filter(Term == "(Intercept)") %>% 
  pull(Fixed_Estimate)

print(paste("Intercept (基準平均):", round(intercept_value, 2)))
```

### ② ランダム効果の抽出

```{r step2_ranef}
random_tkw <- ranef(model_tkw)$Genotype %>%
  as.data.frame() %>%
  rownames_to_column("Genotype") %>%
  rename(Random_Effect = `(Intercept)`)

head(random_tkw)
```

### ③ BLUE（品種能力値）の計算と可視化

```{r step3_calc_blue}
# 計算
blue_tkw <- random_tkw %>%
  mutate(
    Intercept = intercept_value,
    BLUE_TKW = Intercept + Random_Effect # 基準 + その品種の偏差
  ) %>%
  arrange(desc(BLUE_TKW)) # 高い順に並べ替え

# 上位5品種を表示
head(blue_tkw, 5)
```

### ④ 結果の可視化（理解を助ける図）

計算された「品種能力値 (BLUE\_TKW)」と、生のデータ（平均値）の違いを図示します。LMMを使うことで、データのバラつき（ノイズ）がどのように処理されたかがわかります。

```{r visualize, fig.height=6, fig.width=8}
# 生データの品種ごとの平均を計算
raw_means <- df %>%
  group_by(Genotype) %>%
  summarise(Raw_Mean = mean(SPno))

# 結合
plot_data <- left_join(blue_tkw, raw_means, by = "Genotype")

# プロット
ggplot(plot_data) +
  # 生データの平均（グレー）
  geom_point(aes(x = reorder(Genotype, BLUE_TKW), y = Raw_Mean, color = "Raw Mean"), size = 3, alpha = 0.6) +
  # LMMによる推定値（赤）
  geom_point(aes(x = reorder(Genotype, BLUE_TKW), y = BLUE_TKW, color = "LMM Estimate (BLUE)"), size = 3) +
  # その差を線で結ぶ
  geom_segment(aes(x = reorder(Genotype, BLUE_TKW), xend = reorder(Genotype, BLUE_TKW),
                   y = Raw_Mean, yend = BLUE_TKW), color = "gray", linetype = "dashed") +
  coord_flip() +
  labs(
    title = "生データの平均 vs LMMによる推定値 (縮小推定)",
    subtitle = "LMMは極端な値を全体平均(Intercept)の方向に引き寄せる（縮小推定）性質があります",
    x = "Genotype",
    y = "SPno Value",
    color = "Legend"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("LMM Estimate (BLUE)" = "red", "Raw Mean" = "gray50"))
```

**図の解説**:

  * **グレーの点**: 単純な算術平均。環境の偏りや、データ数が少ない場合の偶然の誤差を含んでいます。
  * **赤の点**: LMMで計算した能力値。
  * **縮小推定 (Shrinkage)**: LMMには、データが少ない場合や極端な値が出た場合に、全体平均（Intercept）の方へ値を引き寄せる性質があります。これにより、偶然による過大評価・過小評価を防ぎ、より「真の実力」に近い値を推定します。

# 7\. REML = TRUE の意味

モデル作成時に `REML = TRUE`（デフォルト）となっていることの重要性について。

  * **ML (Maximum Likelihood)**: 分散を推定する際、サンプル数 $n$ で割る（少し小さく見積もってしまう＝偏りがある）。
  * **REML (Restricted ML)**: 固定効果の自由度を考慮して $n-p$ で割るイメージ（不偏分散に近い）。

**結論**:
分散成分（Genotypeの分散など）を正確に知りたい場合や、最終的なモデル推定には **REML** が適しています。モデル同士を比較する（尤度比検定など）場合は、一時的に `REML = FALSE` にすることがあります。

# 8\. まとめ

1.  **Intercept** は基準となる環境（固定効果の基準）での平均値。
2.  **固定効果** は環境によるプラスマイナスの影響（品種選抜には不要な情報）。
3.  **ランダム効果** は品種ごとの固有の能力（平均からの偏差）。
4.  **BLUE (またはPredicted Value)** = Intercept + ランダム効果。これが環境補正済みの品種能力。
5.  **LMMの利点**: データ欠損に強く、極端な値を補正（縮小推定）してくれるため、単純平均よりも信頼性が高い。

<!-- end list -->

```

